cap log close
log using massachusetts_cleaning.log, replace



cd "/Users/benjaminm/Documents/State_Repository_Research/Massachusetts"


// Remaping Raw Data into Standard Format, and appending together

//import excel "mass_districts_parcc", clear
// save mass_districts_parcc
use mass_districts_parcc, clear 


split C, parse(" ")
drop C C1 C4
rename C2 GradeLevel
rename C3 Subject

rename A DataLevel	
rename B SchYear 	

rename D StudentGroup	
rename E DistName
rename F StateAssignedDistID
drop G 	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev5_count	
rename K Lev5_percent	
rename L Lev4_count	
rename M Lev4_percent	
rename N Lev3_count
rename O Lev3_percent	
rename P Lev2_count		
rename Q Lev2_percent
rename R Lev1_count		
rename S Lev1_percent								
rename T AvgScaleScore
rename U StudentGroup_TotalTested	
rename V CPI
rename W CPI_2	
rename X Median_SGP	
rename Y Median_SGP_2

replace DataLevel = "State" if DistName == "State Totals"
replace DistName = "" if DistName == "State Totals"


save mass_districts_parcc_titled, replace
// use mass_districts_parcc_titled, clear

// Creating file with unique districts and IDs
duplicates drop DistName, force
keep DistName StateAssignedDistID
drop if DistName == "District Name"

input 
Wareham	03100000
 end

drop if DistName == "DistName"

save mass_district_IDs_parcc, replace



//import excel "mass_schools_parcc", clear
// save mass_schools_parcc, replace
use mass_schools_parcc, clear

// import excel "mass_schools_old_mcas_2", clear
// save mass_schools_old_mcas_2, replace

drop if F == "State Totals - State Totals"

split F, parse(" - ")

rename F1 DistName 
rename F2 SchName

split C, parse(" ")
drop C C1 C4
rename C2 GradeLevel
rename C3 Subject

keep if E == "All"


rename A DataLevel	
rename B SchYear 	

rename D StudentGroup	
drop E 
rename G StateAssignedSchID
drop H	
rename I ProficientOrAbove_count
rename J ProficientOrAbove_percent	
rename K Lev5_count	
rename L Lev5_percent	
rename M Lev4_count	
rename N Lev4_percent	
rename O Lev3_count
rename P Lev3_percent	
rename Q Lev2_count		
rename R Lev2_percent
rename S Lev1_count		
rename T Lev1_percent								
rename U AvgScaleScore
rename V StudentGroup_TotalTested	
rename W CPI
rename X CPI_2	
rename Y Median_SGP	
rename Z Median_SGP_2 	



append using mass_districts_parcc_titled
drop StateAssignedDistID


merge m:1 DistName using mass_district_IDs_parcc



drop if DistName == "School Name"
drop if DistName == "District Name"

drop _merge



// Loop to merge with NCES data, separate into individual years and add necessary variables


global years3 2015 2016

foreach a in $years3 {
	
local prevyear = `a' - 1
	
use mass_districts_parcc_in_progress, clear


keep if SchYear == "`a'"


replace StateAssignedDistID = subinstr(StateAssignedDistID, "0000", "", .)

rename StateAssignedDistID State_leaid

merge m:1 State_leaid using 1_NCES_`prevyear'_District_Mass // Changed
rename _merge DistMerge
drop if DistMerge == 2 // dropping unmerge districts from NCES

rename State_leaid StateAssignedDistID

//NEW ADDED

label def DataLevel 1 "State" 2 "District" 3 "School"
encode DataLevel, gen(DataLevel_n) label(DataLevel)
sort DataLevel_n 
drop DataLevel 
rename DataLevel_n DataLevel 



replace DistName = "All Districts" if DataLevel == 1
replace SchName = "All Schools" if DataLevel == 1

replace SchName = "All Schools" if DataLevel == 2


// NEW ADDED


rename StateAssignedSchID seasch
merge m:1 seasch using 1_NCES_`prevyear'_School_Mass // Changed
rename _merge SchoolMerge
drop if SchoolMerge == 2 // dropping unmerge districts from NCES

rename seasch StateAssignedSchID



drop State
drop StateAbbrev
drop StateFips
gen State = "Massachusetts"
gen StateAbbrev = "MA"
gen StateFips = 25 // CHANGED

if `a' == 2016 {
gen Flag_AssmtNameChange = "N"
gen Flag_CutScoreChange_ELA = "N"
gen Flag_CutScoreChange_math = "N"
gen Flag_CutScoreChange_read = ""
gen Flag_CutScoreChange_oth = ""
}


if `a' == 2015 {
// year specific 2016 
gen Flag_AssmtNameChange = "Y"
gen Flag_CutScoreChange_ELA = "Y"
gen Flag_CutScoreChange_math = "Y"
gen Flag_CutScoreChange_read = ""
gen Flag_CutScoreChange_oth = ""

}

if `a' == 2015 {
gen SchYear2 = "2014-15"

} 

if `a' == 2016 {
gen SchYear2 = "2015-16"

} 


drop SchYear
rename SchYear2 SchYear

gen AssmtName = "PARCC"
gen AssmtType = "Regular"

gen Subject2 = "" 
replace Subject2 = "math" if Subject == "MATH"
replace Subject2 = "ela" if Subject == "ELA/L"
drop Subject
rename Subject2 Subject

drop if Subject == ""


gen GradeLevel2 = ""
replace GradeLevel2 = "G03" if GradeLevel == "3"
replace GradeLevel2 = "G04" if GradeLevel == "4"
replace GradeLevel2 = "G05" if GradeLevel == "5"
replace GradeLevel2 = "G06" if GradeLevel == "6"
replace GradeLevel2 = "G07" if GradeLevel == "7"
replace GradeLevel2 = "G08" if GradeLevel == "8"
replace GradeLevel2 = "G09" if GradeLevel == "9"
replace GradeLevel2 = "G10" if GradeLevel == "10"
replace GradeLevel2 = "G11" if GradeLevel == "11"

drop GradeLevel
rename GradeLevel2 GradeLevel

drop if GradeLevel == "G09"
drop if GradeLevel == "G10"
drop if GradeLevel == "G11"
drop if GradeLevel == "HS SCI"

drop if GradeLevel == ""


//CHANGED
gen StudentSubGroup = ""
replace StudentSubGroup = "All Students" if StudentGroup == "All Students"
replace StudentSubGroup = "American Indian or Alaska Native" if StudentGroup == "Amer. Ind. or Alaska Nat."
replace StudentSubGroup = "Asian" if StudentGroup == "Asian"
replace StudentSubGroup = "Black or African American" if StudentGroup == "Afr. Amer./Black"
replace StudentSubGroup = "Native Hawaiian or Pacific Islander" if StudentGroup == "Nat. Haw. or Pacif. Isl."
replace StudentSubGroup = "Two or More" if StudentGroup == "Multi-race, Non-Hisp./Lat."
replace StudentSubGroup = "Hispanic or Latino" if StudentGroup == "Hispanic/Latino"
replace StudentSubGroup = "White" if StudentGroup == "White"

replace StudentSubGroup = "English Learner" if StudentGroup == "EL"

replace StudentSubGroup = "Economically Disadvantaged" if StudentGroup == "Econ. Disadvantaged"
replace StudentSubGroup = "Not Economically Disadvantaged" if StudentGroup == "Non-Econ. Disadvantaged"

replace StudentSubGroup = "Male" if StudentGroup == "Male"
replace StudentSubGroup = "Female" if StudentGroup == "Female"


drop if StudentSubGroup == ""
drop StudentGroup

gen StudentGroup = ""
replace StudentGroup = "All Students" if StudentSubGroup == "All Students"
replace StudentGroup = "RaceEth" if StudentSubGroup == "American Indian or Alaska Native"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Asian"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Black or African American"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Native Hawaiian or Pacific Islander"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Two or More"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Hispanic or Latino"
replace StudentGroup = "RaceEth" if StudentSubGroup == "White"

replace StudentGroup = "EL Status" if StudentSubGroup == "English Learner"

replace StudentGroup = "Gender" if StudentSubGroup == "Male"
replace StudentGroup = "Gender" if StudentSubGroup == "Female"


replace StudentGroup = "Economic Status" if StudentSubGroup == "Economically Disadvantaged"
replace StudentGroup = "Economic Status" if StudentSubGroup == "Not Economically Disadvantaged"
//CHANGED


gen ProficiencyCriteria = "Levels 4 and 5"
gen seasch = "" // CHANGED

// Part Rate 
gen ParticipationRate = ""


gen State_leaid = StateAssignedDistID // CHANGED


// CHANGED
// Creating StudentSubGroup_TotalTested 

gen StudentSubGroup_TotalTested = StudentGroup_TotalTested
destring StudentGroup_TotalTested, replace force ignore(",")
// replace StudentGroup_TotalTested = -1000000 if StudentGroup_TotalTested == .
bys StudentGroup Subject GradeLevel DistName SchName: egen StudentGroup_TotalTested1 = total(StudentGroup_TotalTested)
replace StudentGroup_TotalTested1 =. if StudentGroup_TotalTested1 < 0
tostring StudentGroup_TotalTested1, replace
replace StudentGroup_TotalTested1 = "*" if StudentGroup_TotalTested1 == "."
drop StudentGroup_TotalTested
rename StudentGroup_TotalTested1 StudentGroup_TotalTested
// CHANGED



// NEW ADDED 
// removes commas from StudentSubGroup_TotalTested
replace StudentSubGroup_TotalTested = subinstr(StudentSubGroup_TotalTested, ",", "", .)



decode DistType, gen (DistType1)
drop DistType
rename DistType1 DistType

decode SchType, gen (SchType1)
drop SchType
rename SchType1 SchType

decode SchLevel, gen (SchLevel1)
drop SchLevel
rename SchLevel1 SchLevel

decode SchVirtual, gen (SchVirtual1)
drop SchVirtual
rename SchVirtual1 SchVirtual
// NEW ADDED 



// NEW EDITED
order State StateAbbrev StateFips SchYear DataLevel DistName DistType SchName SchType NCESDistrictID StateAssignedDistID State_leaid NCESSchoolID StateAssignedSchID seasch DistCharter SchLevel SchVirtual CountyName CountyCode AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_read Flag_CutScoreChange_oth 


keep State StateAbbrev StateFips SchYear DataLevel DistName DistType SchName SchType NCESDistrictID StateAssignedDistID State_leaid NCESSchoolID StateAssignedSchID seasch DistCharter SchLevel SchVirtual CountyName CountyCode AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_read Flag_CutScoreChange_oth 
// NEW EDITED

destring Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate AvgScaleScore, replace force ignore(",") // CHANGED


// converting to decimal form from percentage form 
replace Lev1_percent = Lev1_percent/100 
replace Lev2_percent = Lev2_percent/100 
replace Lev3_percent = Lev3_percent/100 
replace Lev4_percent = Lev4_percent/100 
replace Lev5_percent = Lev5_percent/100 // NEW ADDED 
replace ProficientOrAbove_percent = ProficientOrAbove_percent/100
replace ParticipationRate = ParticipationRate/100

//NEW ADDED


sort DataLevel DistName Subject GradeLevel StudentGroup StudentSubGroup
//NEW ADDED



save MA_AssmtData_`a'_Stata, replace
export delimited MA_AssmtData_`a'.csv, replace


}

