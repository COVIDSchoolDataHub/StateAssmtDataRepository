cap log close
log using massachusetts_cleaning.log, replace

cd "/Users/benjaminm/Documents/State_Repository_Research/Massachusetts"

// import excel "mass_districts_old_mcas", clear
// save mass_districts_old_mcas
use mass_districts_old_mcas, clear 


drop A 	
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
rename E DistName
rename F StateAssignedDistID
rename G Subject	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev4_count	
rename K Lev4_percent	
rename L Lev3_count	
rename M Lev3_percent	
rename N Lev2_count
rename O Lev2_percent	
rename P Lev1_count		
rename Q Lev1_percent				
rename R StudentGroup_TotalTested	
rename S CPI
rename T Median_SGP	
rename U Median_SGP_2 	


save mass_districts_old_mcas_titled, replace
// use mass_districts_new_mcas_titled, clear

// Creating file with unique districts and IDs
duplicates drop DistName, force
keep DistName StateAssignedDistID
drop if DistName == "District Name"

save mass_district_IDs_old, replace


//import excel "mass_schools_old_mcas", clear
// save mass_schools_old_mcas, replace
use mass_schools_old_mcas, clear


// import excel "mass_schools_old_mcas_2", clear
// save mass_schools_old_mcas_2, replace

append using mass_schools_old_mcas_2

split F, parse(" - ")


egen long_district_name = concat(F1 F2), punct(" - ") 
egen long_school_name = concat(F3 F4), punct(" - ")


replace F1 = long_district_name if long_district_name == "Community Day Charter Public School - Prospect (District)"
replace F1 = long_district_name if long_district_name == "Excel Academy Charter School - Chelsea (District)"
replace F1 = long_district_name if long_district_name == "Excel Academy Charter School - Boston II (District)"

replace F2 = long_school_name if long_school_name == "Community Day Charter Public School - Prospect"
replace F2 = long_school_name if long_school_name == "Excel Academy Charter School - Boston II"
replace F2 = long_school_name if long_school_name == "Excel Academy Charter School - Chelsea"


drop F3 F4
drop long_district_name
drop long_school_name
rename F1 DistName 
rename F2 SchName

keep if E == "All"

drop A
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
drop E 
drop F
rename G StateAssignedSchID
rename H Subject	
rename I ProficientOrAbove_count
rename J ProficientOrAbove_percent	
rename K Lev4_count	
rename L Lev4_percent	
rename M Lev3_count	
rename N Lev3_percent	
rename O Lev2_count
rename P Lev2_percent	
rename Q Lev1_count		
rename R Lev1_percent				
rename S StudentGroup_TotalTested	
rename T CPI
rename U Median_SGP	
rename V Median_SGP_2 	


append using mass_districts_old_mcas_titled
drop StateAssignedDistID


merge m:1 DistName using mass_district_IDs_old


drop if DistName == "School Name"
drop if DistName == "District Name"

replace DistName = "State Total" if _merge == 1

drop _merge


// save mass_districts_old_mcas_in_progress, replace
// use mass_districts_old_mcas_in_progress, clear


global years2 2010 2011 2012 2013 2014

foreach a in $years2 {
	
local prevyear = `a' - 1
	
use mass_districts_old_mcas_in_progress, clear

keep if SchYear == "`a'"


replace StateAssignedDistID = subinstr(StateAssignedDistID, "0000", "", .)

rename StateAssignedDistID State_leaid

merge m:1 State_leaid using NCES_`prevyear'_District_Mass
rename _merge DistMerge
drop if DistMerge == 2 // dropping unmerge districts from NCES

rename State_leaid StateAssignedDistID

drop DistMerge

rename StateAssignedSchID seasch
merge m:1 seasch using NCES_`prevyear'_School_Mass
rename _merge SchoolMerge
drop if SchoolMerge == 2 // dropping unmerge districts from NCES

rename seasch StateAssignedSchID



drop State
drop StateAbbrev
drop StateFips
gen State = "Massachusetts"
gen StateAbbrev = "MA"
gen StateFips = "25"


gen Flag_AssmtNameChange = "N"
gen Flag_CutScoreChange_ELA = "N"
gen Flag_CutScoreChange_math = "N"
gen Flag_CutScoreChange_read = ""
gen Flag_CutScoreChange_oth = "N"
 


if `a' == 2010 {
gen SchYear2 = "2009-10"

} 

if `a' == 2011 {
gen SchYear2 = "2010-11"

} 

if `a' == 2012 {
gen SchYear2 = "2011-12"

} 

if `a' == 2013 {
gen SchYear2 = "2012-13"

} 

if `a' == 2014 {
gen SchYear2 = "2013-14"

} 

drop SchYear
rename SchYear2 SchYear

gen AssmtName = "MCAS"
gen AssmtType = "Regular"
gen DataLevel = "State, District, School"

gen Subject2 = "" 
replace Subject2 = "MTH" if Subject == "MATH"
replace Subject2 = "ELA" if Subject == "ELA"
replace Subject2 = "SCI" if Subject == "SCI"
drop Subject
rename Subject2 Subject


gen GradeLevel2 = ""
replace GradeLevel2 = "G03" if GradeLevel == "03"
replace GradeLevel2 = "G04" if GradeLevel == "04"
replace GradeLevel2 = "G05" if GradeLevel == "05"
replace GradeLevel2 = "G06" if GradeLevel == "06"
replace GradeLevel2 = "G07" if GradeLevel == "07"
replace GradeLevel2 = "G08" if GradeLevel == "08"
replace GradeLevel2 = "G10" if GradeLevel == "10"
replace GradeLevel2 = "G11" if GradeLevel == "11"
replace GradeLevel2 = "ALL" if GradeLevel == "AL"
drop GradeLevel
rename GradeLevel2 GradeLevel

drop if GradeLevel == "G10"
drop if GradeLevel == "G11"
drop if GradeLevel == "HS SCI"

drop if GradeLevel == ""

gen ProficiencyCriteria = "Levels 3 and 4"
gen seasch = . 
gen StudentSubGroup = ""

// Empty Count Vars 
gen Lev5_count = ""
gen Lev5_percent = ""
gen AvgScaleScore = ""
gen ParticipationRate = ""


gen StudentSubGroup_TotalTested = StudentGroup_TotalTested
destring StudentGroup_TotalTested, replace force
replace StudentGroup_TotalTested = -1000000 if StudentGroup_TotalTested == .
bys SchName StudentGroup: egen StudentGroup_TotalTested1 = total(StudentGroup_TotalTested)
replace StudentGroup_TotalTested1 =. if StudentGroup_TotalTested1 < 0
tostring StudentGroup_TotalTested1, replace
replace StudentGroup_TotalTested1 = "*" if StudentGroup_TotalTested1 == "."
drop StudentGroup_TotalTested
rename StudentGroup_TotalTested1 StudentGroup_TotalTested


order State StateAbbrev StateFips NCESDistrictID State_leaid DistrictType Charter CountyName CountyCode NCESSchoolID SchoolType Virtual  seasch SchoolLevel SchYear AssmtName Flag_AssmtNameChange Flag_CutScoreChange_ELA	Flag_CutScoreChange_math Flag_CutScoreChange_read	Flag_CutScoreChange_oth AssmtType DataLevel DistName StateAssignedDistID SchName Subject StateAssignedSchID GradeLevel StudentGroup  StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate 

keep State StateAbbrev StateFips NCESDistrictID State_leaid DistrictType Charter CountyName CountyCode NCESSchoolID SchoolType Virtual  seasch SchoolLevel SchYear AssmtName Flag_AssmtNameChange Flag_CutScoreChange_ELA	Flag_CutScoreChange_math Flag_CutScoreChange_read	Flag_CutScoreChange_oth AssmtType DataLevel DistName StateAssignedDistID SchName Subject StateAssignedSchID GradeLevel StudentGroup  StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate 

destring Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate AvgScaleScore, replace force


// converting to decimal form from percentage form 
replace Lev1_percent = Lev1_percent/100 
replace Lev2_percent = Lev2_percent/100 
replace Lev3_percent = Lev3_percent/100 
replace Lev4_percent = Lev4_percent/100 


save MA_AssmtData_`a'_Stata, replace
export delimited MA_AssmtData_`a'.csv, replace


}



