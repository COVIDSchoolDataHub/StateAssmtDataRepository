cap log close
log using mass_nces_cleaning.log, replace



cd "/Users/benjaminm/Documents/State_Repository_Research/Massachusetts"

use NCES_2016_School.dta, clear

global years 2016 2017 2018 2019 2020 

foreach a in $years {
	
	use "NCES_`a'_School.dta", clear
	keep if state_fips == 25
	
	rename state_name State
	rename state_location StateAbbrev
	rename state_fips StateFips
	rename ncesdistrictid NCESDistrictID
	rename state_leaid State_leaid
	rename charter Charter
	rename county_code CountyCode
	rename ncesschoolid NCESSchoolID
	rename school_type SchoolType
	rename virtual Virtual  // Might not work for 2021
	rename school_level SchoolLevel
	
	split seasch, parse("-")
	drop seasch seasch1
	rename seasch2 seasch

	
	save "NCES_`a'_School_Mass.dta", replace
	
	use "NCES_`a'_District.dta", clear 
	keep if state_fips == 25
	
	rename state_name State
	rename state_location StateAbbrev
	rename state_fips StateFips
	rename ncesdistrictid NCESDistrictID
	rename state_leaid State_leaid
	rename district_agency_type DistrictType
	rename lea_name DistName
	rename county_name CountyName
	rename county_code CountyCode
	
	replace State_leaid = subinstr(State_leaid, "MA-", "", .)
	
	save "NCES_`a'_District_Mass.dta", replace
	
}

global years 2009 2010 2011 2012 2013 2014 2015

foreach a in $years {
	
	use "NCES_`a'_School.dta", clear
	keep if state_fips == 25
	
	rename state_name State
	rename state_location StateAbbrev
	rename state_fips StateFips
	rename ncesdistrictid NCESDistrictID
	rename state_leaid State_leaid
	rename charter Charter
	rename county_code CountyCode
	rename ncesschoolid NCESSchoolID
	rename school_type SchoolType
	rename virtual Virtual  // Might not work for 2021
	rename school_level SchoolLevel

	
	save "NCES_`a'_School_Mass.dta", replace
	
	use "NCES_`a'_District.dta", clear 
	keep if state_fips == 25
	
	rename state_name State
	rename state_location StateAbbrev
	rename state_fips StateFips
	rename ncesdistrictid NCESDistrictID
	rename state_leaid State_leaid
	rename district_agency_type DistrictType
	rename lea_name DistName
	rename county_name CountyName
	rename county_code CountyCode
	
	replace State_leaid = subinstr(State_leaid, "MA-", "", .)
	
	save "NCES_`a'_District_Mass.dta", replace
	
}

// Just 2021 District

import delimited NCES_2021_District, clear
keep if statefips == 25
	
	rename state State
	rename stateabbrev StateAbbrev
	rename statefips StateFips
	rename ncesdistrictid NCESDistrictID
	rename districttype DistrictType
	rename state_leaid State_leaid
	rename charter Charter
	rename countyname CountyName
	rename countycode CountyCode
	rename distname DistName
	
	replace State_leaid = subinstr(State_leaid, "MA-", "", .)
	
// replace DistName = subinstr(DistName, "District", "", .)
// replace DistName = strrtrim(DistName)
	
save NCES_2021_District_Mass, replace

// Just 2021 School 
import delimited NCES_2021_School, clear
keep if statefips == 25
keep ncesschoolid schooltype virtual schoollevel schname st_schid schid sy_status_text 
	
	rename ncesschoolid NCESSchoolID
	rename schooltype SchoolType
	rename virtual Virtual  // Might not work for 2021
	rename schoollevel SchoolLevel
	rename schname SchoolName
	rename st_schid State_School_ID
	rename schid State_School_ID_Extra
	rename sy_status_text School_Open_Status
	
replace State_School_ID = subinstr(State_School_ID, "MA-", "", .)
	split State_School_ID, parse("-")
	
drop State_School_ID State_School_ID1
rename State_School_ID2 State_School_ID
	
save NCES_2021_School_Mass, replace
use NCES_2021_School_Mass, clear


// fix to Mass 2013 NCES

use NCES_2013_School_Mass, clear
duplicates drop seasch, force

save NCES_2013_School_Mass, replace
