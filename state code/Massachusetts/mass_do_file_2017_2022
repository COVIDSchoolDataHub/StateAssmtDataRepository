cap log close
log using massachusetts_cleaning.log, replace



cd "/Users/benjaminm/Documents/State_Repository_Research/Massachusetts"


// Remaping Raw Data into Standard Format, and appending together

// cleaning district science data
// r3 added
import excel "mass_district_science", clear
save mass_district_science, replace
use mass_district_science, clear

rename A DataLevel	
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
rename E DistName
rename F StateAssignedDistID
rename G Subject	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev4_count	
rename K Lev4_percent	
rename L Lev3_count	
rename M Lev3_percent	
rename N Lev2_count
rename O Lev2_percent	
rename P Lev1_count		
rename Q Lev1_percent				
rename R StudentGroup_TotalTested	
rename S CPI
rename T SGP	
rename U SGP_2 
gen ParticipationRate = ""	
gen AvgScaleScore = ""
drop CPI

order DataLevel SchYear GradeLevel StudentGroup	DistName StateAssignedDistID Subject ProficientOrAbove_count ProficientOrAbove_percent Lev4_count Lev4_percent	Lev3_count	Lev3_percent Lev2_count Lev2_percent Lev1_count	Lev1_percent StudentGroup_TotalTested ParticipationRate AvgScaleScore SGP SGP_2

gen AssmtName = "Legacy MCAS"


save mass_district_science_cleaned, replace 
// r3 added


// cleaning district data 
// import excel "mass_districts_new_mcas", clear
// save mass_districts_new_mcas
use mass_districts_new_mcas, clear 

rename A DataLevel	
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
rename E DistName
rename F StateAssignedDistID
rename G Subject	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev4_count	
rename K Lev4_percent	
rename L Lev3_count	
rename M Lev3_percent	
rename N Lev2_count
rename O Lev2_percent	
rename P Lev1_count		
rename Q Lev1_percent				
rename R StudentGroup_TotalTested	
rename S ParticipationRate
rename T AvgScaleScore	
rename U SGP 	
rename V SGP_2
drop W 

gen AssmtName = "NextGen MCAS"

append using mass_district_science_cleaned

// drop early school years
// make sure append went well

replace DataLevel = "State" if DistName == "State Total"
replace DistName = "" if DistName == "State Total"

// r3 added 
drop if SchYear == "2015" | SchYear == "2016"
// r3 added

save mass_districts_new_mcas_titled, replace // change subject renaming for sci
// use mass_districts_new_mcas_titled, clear

// Creating file with unique districts and IDs
duplicates drop DistName, force
keep DistName StateAssignedDistID
drop if DistName == "District Name"

input 
"Community Day Charter Public School" 04260000
end

save mass_district_IDs, replace




// cleaning school science data 
// r3 added
//import excel "mass_school_science", clear
//save mass_school_science, replace
use mass_school_science, clear



drop if E == "State Total ( ALL )"

split E, parse(" - ")


egen long_district_name = concat(E1 E2), punct(" - ") 
egen long_school_name = concat(E3 E4), punct(" - ")


replace E1 = long_district_name if long_district_name == "Community Day Charter Public School - Prospect (District)"
replace E1 = long_district_name if long_district_name == "Excel Academy Charter School - Chelsea (District)"
replace E1 = long_district_name if long_district_name == "Excel Academy Charter School - Boston II (District)"

replace E2 = long_school_name if long_school_name == "Community Day Charter Public School - Prospect"
replace E2 = long_school_name if long_school_name == "Excel Academy Charter School - Boston II"
replace E2 = long_school_name if long_school_name == "Excel Academy Charter School - Chelsea"


drop E3 E4
drop long_district_name
drop long_school_name
rename E1 DistName 
rename E2 SchName


rename A DataLevel
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
drop E 
// drop F
rename F StateAssignedSchID
rename G Subject	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev4_count	
rename K Lev4_percent	
rename L Lev3_count	
rename M Lev3_percent	
rename N Lev2_count
rename O Lev2_percent	
rename P Lev1_count		
rename Q Lev1_percent				
rename R StudentGroup_TotalTested	
rename S CPI
rename T SGP	
rename U SGP_2 	

gen ParticipationRate = ""	
gen AvgScaleScore = ""
drop CPI

// r3 added 
drop if SchYear == "2015" | SchYear == "2016"
// r3 added

gen AssmtName = "Legacy MCAS"

save mass_school_science_cleaned, replace  
// r3 added




// cleaning school data 
// import excel "mass_schools_new_mcas", clear
// save mass_schools_new_mcas, replace
use mass_schools_new_mcas, clear

drop if E == "State Total"

split E, parse(" - ")

egen long_district_name = concat(E1 E2), punct(" - ") 
egen long_school_name = concat(E3 E4), punct(" - ")

replace E1 = long_district_name if long_district_name == "Community Day Charter Public School - R. Kingman Webster (District)"
replace E1 = long_district_name if long_district_name == "Community Day Charter Public School - Gateway (District)"

replace E2 = long_school_name if long_school_name == "Community Day Charter Public School - R. Kingman Webster"
replace E2 = long_school_name if long_school_name == "Community Day Charter Public School - Gateway"


drop E3 E4
drop long_district_name
drop long_school_name
rename E1 DistName 
rename E2 SchName

rename A DataLevel
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup	
drop E 
rename F StateAssignedSchID
rename G Subject	
rename H ProficientOrAbove_count
rename I ProficientOrAbove_percent	
rename J Lev4_count	
rename K Lev4_percent	
rename L Lev3_count	
rename M Lev3_percent	
rename N Lev2_count
rename O Lev2_percent	
rename P Lev1_count		
rename Q Lev1_percent				
rename R StudentGroup_TotalTested	
rename S ParticipationRate
rename T AvgScaleScore	
rename U SGP 	
rename V SGP_2
drop W X

gen AssmtName = "NextGen MCAS"

// r3 change
append using mass_school_science_cleaned
// r3 change



// appending districts to general and science data
append using mass_districts_new_mcas_titled
drop StateAssignedDistID


merge m:1 DistName using mass_district_IDs

drop if DistName == "School Name"
drop if DistName == "District Name"

drop _merge

save mass_districts_new_mcas_in_progress_1, replace

use mass_districts_new_mcas_in_progress_1, replace







// importing district participation data and merging

// r3 changed
//import excel "mass_district_participation_new_2", clear
//save mass_district_participation_new, replace
use mass_district_participation_new, clear

rename A DataLevel
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup
rename E Subject
rename G StateAssignedDistID
rename I ParticipationRate_New // part rate switches to H in 2016 and prior, but we only need 2017 and above here 



// replace StudentSubGroup = "Native Hawaiian or Pacific Islander" if StudentGroup == "Nat. Haw. or Pacif. Isl." // doesn't exist in part data
replace StudentGroup = "Multi-race, Non-Hisp./Lat." if StudentGroup == "Multi-race, Non-Hisp." 

// replace StudentSubGroup = "English Learner" if StudentGroup == "EL" // not in part data

replace StudentGroup = "Econ. Disadvantaged" if StudentGroup == "Economically Disadvantaged"
// replace StudentSubGroup = "Not Economically Disadvantaged" if StudentGroup == "Non-Econ. Disadvantaged" // doesn't exist in part data

//replace StudentSubGroup = "Male" if StudentGroup == "Male" // doesn't exist in part data
// replace StudentSubGroup = "Female" if StudentGroup == "Female" // doesn't exist in part data


replace Subject = "MATH" if Subject == "Mathematics"
replace Subject = "ELA" if Subject == "English"
replace Subject = "SCI" if Subject == "Science"



//duplicates list DataLevel SchYear GradeLevel StudentGroup Subject StateAssignedDistID

save mass_district_participation_cleaned, replace

use mass_district_participation_cleaned, clear


use mass_districts_new_mcas_in_progress_1, replace
merge m:1 DataLevel SchYear GradeLevel StudentGroup Subject StateAssignedDistID using mass_district_participation_cleaned
drop H
drop if _merge == 2
drop _merge


save mass_districts_new_mcas_in_progress_2, replace



// school participation cleaning and merging
//import excel "mass_school_participation_new", clear
//save mass_school_participation, replace
use mass_school_participation, clear


rename A DataLevel
rename B SchYear 	
rename C GradeLevel
rename D StudentGroup
rename E Subject
rename G StateAssignedSchID
rename I ParticipationRate_New_School // part rate switches to H in 2016 and less, but we only need 2017 and above here 


// replace StudentSubGroup = "Native Hawaiian or Pacific Islander" if StudentGroup == "Nat. Haw. or Pacif. Isl." // doesn't exist in part data
replace StudentGroup = "Multi-race, Non-Hisp./Lat." if StudentGroup == "Multi-race, Non-Hisp." 

// replace StudentSubGroup = "English Learner" if StudentGroup == "EL" // not in part data

replace StudentGroup = "Econ. Disadvantaged" if StudentGroup == "Economically Disadvantaged"
// replace StudentSubGroup = "Not Economically Disadvantaged" if StudentGroup == "Non-Econ. Disadvantaged" // doesn't exist in part data

//replace StudentSubGroup = "Male" if StudentGroup == "Male" // doesn't exist in part data
// replace StudentSubGroup = "Female" if StudentGroup == "Female" // doesn't exist in part data


replace Subject = "MATH" if Subject == "Mathematics"
replace Subject = "ELA" if Subject == "English"
replace Subject = "SCI" if Subject == "Science"

save mass_school_participation_cleaned, replace

use mass_school_participation_cleaned, clear

use mass_districts_new_mcas_in_progress_2, replace
merge m:1 DataLevel SchYear GradeLevel StudentGroup Subject StateAssignedSchID using mass_school_participation_cleaned
drop H
drop if _merge == 2
drop _merge

replace ParticipationRate_New = ParticipationRate_New_School if DataLevel == "School"
replace ParticipationRate_New = ParticipationRate if ParticipationRate_New == "" & ParticipationRate != "NN/AA"
replace ParticipationRate_New = "" if ParticipationRate_New == "N/A"
drop ParticipationRate_New_School ParticipationRate
rename ParticipationRate_New ParticipationRate

//recast
 
destring ParticipationRate, replace 
tostring ParticipationRate, replace force


save mass_districts_new_mcas_in_progress_3, replace 
// r3 change






// Loop to merge with NCES data, separate into individual years and add necessary variables

global years1 2017 2018 2019 2021 2022 

foreach a in $years1 {
	
local prevyear = `a' - 1
	
use mass_districts_new_mcas_in_progress_3, clear

keep if SchYear == "`a'"

replace StateAssignedDistID = subinstr(StateAssignedDistID, "0000", "", .)

rename StateAssignedDistID State_leaid

// District NCES Merge
merge m:1 State_leaid using 1_NCES_`prevyear'_District_Mass // CHANGED
rename _merge DistMerge
drop if DistMerge == 2

rename State_leaid StateAssignedDistID

drop DistMerge

//NEW ADDED

label def DataLevel 1 "State" 2 "District" 3 "School"
encode DataLevel, gen(DataLevel_n) label(DataLevel)
sort DataLevel_n 
drop DataLevel 
rename DataLevel_n DataLevel 



replace DistName = "All Districts" if DataLevel == 1
replace SchName = "All Schools" if DataLevel == 1

replace SchName = "All Schools" if DataLevel == 2


// NEW ADDED

	
rename StateAssignedSchID seasch
merge m:1 seasch using 1_NCES_`prevyear'_School_Mass // CHANGED 
rename _merge SchoolMerge
drop if SchoolMerge == 2

rename seasch StateAssignedSchID

drop SchoolMerge



drop State
drop StateAbbrev
drop StateFips
gen State = "Massachusetts"
gen StateAbbrev = "MA"
gen StateFips = 25 // CHANGED

if `a' == 2017 {
// year specific 2017 
gen Flag_AssmtNameChange = "Y"
gen Flag_CutScoreChange_ELA = "Y"
gen Flag_CutScoreChange_math = "Y"
gen Flag_CutScoreChange_read = ""
gen Flag_CutScoreChange_oth = "Y"

}

if `a' != 2017 {
gen Flag_AssmtNameChange = "N"
gen Flag_CutScoreChange_ELA = "N"
gen Flag_CutScoreChange_math = "N"
gen Flag_CutScoreChange_read = ""
gen Flag_CutScoreChange_oth = "N"

}

// year specific 


if `a' == 2017 {
gen SchYear2 = "2016-17"

} 

if `a' == 2018 {
gen SchYear2 = "2017-18"

} 

if `a' == 2019 {
gen SchYear2 = "2018-19"

} 

if `a' == 2021 {
gen SchYear2 = "2020-21"

} 

if `a' == 2022 {
gen SchYear2 = "2021-22"

} 

drop SchYear
rename SchYear2 SchYear

//gen AssmtName = "MCAS" // r3 changed
gen AssmtType = "Regular"




gen Subject2 = "" 
replace Subject2 = "math" if Subject == "MATH"
replace Subject2 = "ela" if Subject == "ELA"
replace Subject2 = "sci" if Subject == "SCI"

drop Subject
rename Subject2 Subject


gen GradeLevel2 = ""
replace GradeLevel2 = "G03" if GradeLevel == "03"
replace GradeLevel2 = "G04" if GradeLevel == "04"
replace GradeLevel2 = "G05" if GradeLevel == "05"
replace GradeLevel2 = "G06" if GradeLevel == "06"
replace GradeLevel2 = "G07" if GradeLevel == "07"
replace GradeLevel2 = "G08" if GradeLevel == "08"
replace GradeLevel2 = "G10" if GradeLevel == "10"
replace GradeLevel2 = "G11" if GradeLevel == "11"
replace GradeLevel2 = "G38" if GradeLevel == "ALL (03-08)"
drop GradeLevel
rename GradeLevel2 GradeLevel

drop if GradeLevel == "G10"
drop if GradeLevel == "G11"
drop if GradeLevel == ""


//CHANGED

tab StudentGroup
gen StudentSubGroup = ""
replace StudentSubGroup = "All Students" if StudentGroup == "All Students"
replace StudentSubGroup = "American Indian or Alaska Native" if StudentGroup == "Amer. Ind. or Alaska Nat."
replace StudentSubGroup = "Asian" if StudentGroup == "Asian"
replace StudentSubGroup = "Black or African American" if StudentGroup == "Afr. Amer./Black"
replace StudentSubGroup = "Native Hawaiian or Pacific Islander" if StudentGroup == "Nat. Haw. or Pacif. Isl."
replace StudentSubGroup = "Two or More" if StudentGroup == "Multi-race, Non-Hisp./Lat."
replace StudentSubGroup = "Hispanic or Latino" if StudentGroup == "Hispanic/Latino"
replace StudentSubGroup = "White" if StudentGroup == "White"

replace StudentSubGroup = "English Learner" if StudentGroup == "EL"

replace StudentSubGroup = "Economically Disadvantaged" if StudentGroup == "Econ. Disadvantaged"
replace StudentSubGroup = "Not Economically Disadvantaged" if StudentGroup == "Non-Econ. Disadvantaged"

replace StudentSubGroup = "Male" if StudentGroup == "Male"
replace StudentSubGroup = "Female" if StudentGroup == "Female"


drop if StudentSubGroup == ""
drop StudentGroup

gen StudentGroup = ""
replace StudentGroup = "All Students" if StudentSubGroup == "All Students"
replace StudentGroup = "RaceEth" if StudentSubGroup == "American Indian or Alaska Native"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Asian"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Black or African American"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Native Hawaiian or Pacific Islander"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Two or More"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Hispanic or Latino"
replace StudentGroup = "RaceEth" if StudentSubGroup == "White"

replace StudentGroup = "EL Status" if StudentSubGroup == "English Learner"

replace StudentGroup = "Gender" if StudentSubGroup == "Male"
replace StudentGroup = "Gender" if StudentSubGroup == "Female"


replace StudentGroup = "Economic Status" if StudentSubGroup == "Economically Disadvantaged"
replace StudentGroup = "Economic Status" if StudentSubGroup == "Not Economically Disadvantaged"
//CHANGED


gen ProficiencyCriteria = "Levels 3 and 4"
gen seasch = StateAssignedSchID // CHANGED //r3 changed

// Empty Count Vars 
gen Lev5_count = "-" //r3 changed
gen Lev5_percent = "-" //r3 changed


gen State_leaid = StateAssignedDistID // CHANGED




// CHANGED
// Creating StudentSubGroup_TotalTested 

gen StudentSubGroup_TotalTested = StudentGroup_TotalTested
destring StudentGroup_TotalTested, replace force ignore(",")
// replace StudentGroup_TotalTested = -1000000 if StudentGroup_TotalTested == .
bys StudentGroup Subject GradeLevel DistName SchName: egen StudentGroup_TotalTested1 = total(StudentGroup_TotalTested)
replace StudentGroup_TotalTested1 =. if StudentGroup_TotalTested1 < 0
tostring StudentGroup_TotalTested1, replace
replace StudentGroup_TotalTested1 = "*" if StudentGroup_TotalTested1 == "."
drop StudentGroup_TotalTested
rename StudentGroup_TotalTested1 StudentGroup_TotalTested
// CHANGED


// NEW ADDED 
// removes commas from StudentSubGroup_TotalTested
replace StudentSubGroup_TotalTested = subinstr(StudentSubGroup_TotalTested, ",", "", .)



decode DistType, gen (DistType1)
drop DistType
rename DistType1 DistType

decode SchType, gen (SchType1)
drop SchType
rename SchType1 SchType

decode SchLevel, gen (SchLevel1)
drop SchLevel
rename SchLevel1 SchLevel

decode SchVirtual, gen (SchVirtual1)
drop SchVirtual
rename SchVirtual1 SchVirtual

// NEW ADDED



// NEW EDITED
order State StateAbbrev StateFips SchYear DataLevel DistName DistType SchName SchType NCESDistrictID StateAssignedDistID State_leaid NCESSchoolID StateAssignedSchID seasch DistCharter SchLevel SchVirtual CountyName CountyCode AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_read Flag_CutScoreChange_oth 


keep State StateAbbrev StateFips SchYear DataLevel DistName DistType SchName SchType NCESDistrictID StateAssignedDistID State_leaid NCESSchoolID StateAssignedSchID seasch DistCharter SchLevel SchVirtual CountyName CountyCode AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_read Flag_CutScoreChange_oth 
// NEW EDITED


destring Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate AvgScaleScore, replace force ignore(",") // CHANGED // r3 changed (no lev 5)


// converting to decimal form from percentage form 
replace Lev1_percent = Lev1_percent/100 
replace Lev2_percent = Lev2_percent/100 
replace Lev3_percent = Lev3_percent/100 
replace Lev4_percent = Lev4_percent/100 
replace ProficientOrAbove_percent = ProficientOrAbove_percent/100
replace ParticipationRate = ParticipationRate/100


// r3 changed 
// missing data = - 
tostring ParticipationRate, replace force

replace ParticipationRate = "-" if ParticipationRate == "."
// r3 changed 


//NEW ADDED


sort DataLevel DistName SchName Subject GradeLevel StudentGroup StudentSubGroup
//NEW ADDED



save MA_AssmtData_`a'_Stata, replace
export delimited MA_AssmtData_`a'.csv, replace


}
