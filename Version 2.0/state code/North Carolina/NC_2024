use "NC_OriginalData_2024", clear 

rename school_code StateAssignedSchID 
rename name SchName
rename subject Subject
rename grade GradeLevel
rename type AssmtType
rename subgroup StudentSubGroup
rename num_tested StudentSubGroup_TotalTested	
rename pct_notprof Lev1_percent
rename pct_l3 Lev2_percent
rename pct_l4 Lev3_percent
rename pct_l5 Lev4_percent
rename pct_glp ProficientOrAbove_percent
rename avg_score AvgScaleScore
drop pct_ccr grade_span

gen State = "North Carolina"
gen StateAbbrev = "NC"
gen StateFips = 37 
gen Lev5_count = ""
gen Lev5_percent = ""
gen Flag_AssmtNameChange = "N"
gen Flag_CutScoreChange_ELA = "N"
gen Flag_CutScoreChange_math = "N"
gen Flag_CutScoreChange_sci = "N" 
gen Flag_CutScoreChange_soc = "Not applicable"

gen SchYear = "2023-24"

gen AssmtName = "End-of-Grade Tests - Edition 5" 

// keeping necessary grades 
gen GradeLevel2 = ""
replace GradeLevel2 = "G03" if GradeLevel == "03"
replace GradeLevel2 = "G04" if GradeLevel == "04"
replace GradeLevel2 = "G05" if GradeLevel == "05"
replace GradeLevel2 = "G06" if GradeLevel == "06"
replace GradeLevel2 = "G07" if GradeLevel == "07"
replace GradeLevel2 = "G08" if GradeLevel == "08"
replace GradeLevel2 = "G38" if GradeLevel == "GS"

drop if GradeLevel2 == ""
drop GradeLevel
rename GradeLevel2 GradeLevel

// keeping necessary test types
keep if AssmtType == "RG"
replace AssmtType = "Regular" if AssmtType == "RG"

// keeping necessary subjects 
gen Subject2 = ""
replace Subject2 = "math" if Subject == "MA"
replace Subject2 = "ela" if Subject == "RD"
replace Subject2 = "sci" if Subject == "SC"
drop if Subject2 == ""
drop Subject
rename Subject2 Subject

// keeping necessary subroups 

gen StudentSubGroup2 = ""
replace StudentSubGroup2 = "All Students" if StudentSubGroup == "ALL"
replace StudentSubGroup2 = "American Indian or Alaska Native" if StudentSubGroup == "AMIN"
replace StudentSubGroup2 = "Asian" if StudentSubGroup == "ASIA"
replace StudentSubGroup2 = "Black or African American" if StudentSubGroup == "BLCK"
replace StudentSubGroup2 = "Native Hawaiian or Pacific Islander" if StudentSubGroup == "PACI"
replace StudentSubGroup2 = "Two or More" if StudentSubGroup == "MULT"
replace StudentSubGroup2 = "Hispanic or Latino" if StudentSubGroup == "HISP"
replace StudentSubGroup2 = "White" if StudentSubGroup == "WHTE"

display "El Late"
replace StudentSubGroup2 = "English Learner" if StudentSubGroup == "ELS"
replace StudentSubGroup2 = "English Proficient" if StudentSubGroup == "NOT_ELS"

replace StudentSubGroup2 = "Economically Disadvantaged" if StudentSubGroup == "EDS"
replace StudentSubGroup2 = "Not Economically Disadvantaged" if StudentSubGroup== "NOT_EDS"

replace StudentSubGroup2 = "Male" if StudentSubGroup == "MALE"
replace StudentSubGroup2 = "Female" if StudentSubGroup == "FEM"

display "Homeless"
replace StudentSubGroup2 = "Homeless" if StudentSubGroup == "HMS"
replace StudentSubGroup2 = "Non-Homeless" if StudentSubGroup == "NOT_HMS"
display "Military"
replace StudentSubGroup2 = "Military" if StudentSubGroup == "MIL"
replace StudentSubGroup2 = "Non-Military" if StudentSubGroup == "NOT_MIL"
display "Migrant"
replace StudentSubGroup2 = "Migrant" if StudentSubGroup == "MIG"
replace StudentSubGroup2 = "Non-Migrant" if StudentSubGroup == "NOT_MIG"
display "SWD"
replace StudentSubGroup2 = "SWD" if StudentSubGroup == "SWD"
replace StudentSubGroup2 = "Non-SWD" if StudentSubGroup == "NOT_SWD"
display "Foster Care"
replace StudentSubGroup2 = "Foster Care" if StudentSubGroup == "FCS"
replace StudentSubGroup2 = "Non-Foster Care" if StudentSubGroup == "NOT_FCS"


drop if StudentSubGroup2 == ""
drop StudentSubGroup
rename StudentSubGroup2 StudentSubGroup


// creating student groups 

gen StudentGroup = ""
replace StudentGroup = "All Students" if StudentSubGroup == "All Students"
replace StudentGroup = "RaceEth" if StudentSubGroup == "American Indian or Alaska Native"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Asian"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Black or African American"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Native Hawaiian or Pacific Islander"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Two or More"
replace StudentGroup = "RaceEth" if StudentSubGroup == "Hispanic or Latino"
replace StudentGroup = "RaceEth" if StudentSubGroup == "White"

replace StudentGroup = "EL Status" if StudentSubGroup == "English Learner"
replace StudentGroup = "EL Status" if StudentSubGroup == "English Proficient"

replace StudentGroup = "Gender" if StudentSubGroup == "Male"
replace StudentGroup = "Gender" if StudentSubGroup == "Female"


replace StudentGroup = "Economic Status" if StudentSubGroup == "Economically Disadvantaged"
replace StudentGroup = "Economic Status" if StudentSubGroup == "Not Economically Disadvantaged"

replace StudentGroup = "Disability Status" if StudentSubGroup == "SWD" | StudentSubGroup == "Non-SWD"
replace StudentGroup = "Homeless Enrolled Status" if StudentSubGroup == "Homeless" | StudentSubGroup == "Non-Homeless" 
replace StudentGroup = "Military Connected Status" if StudentSubGroup == "Military" | StudentSubGroup == "Non-Military" 
replace StudentGroup = "Migrant Status" if StudentSubGroup == "Migrant" | StudentSubGroup == "Non-Migrant"
replace StudentGroup = "Foster Care Status" if StudentSubGroup == "Foster Care" | StudentSubGroup == "Non-Foster Care"


// proficiency level 
gen ProficiencyCriteria = "Levels 2-4" 

// split CODE into district piece, and school piece 
gen StateAssignedDistID = ""
replace StateAssignedDistID = StateAssignedSchID if regexm(StateAssignedSchID, "[0-9]{3}LEA")

// remove LEA piece from stateassigneddistrictID 
replace StateAssignedDistID = subinstr(StateAssignedDistID, "LEA", "", .)

// drop entries which are "regions" by datalevel 
drop if regexm(StateAssignedSchID, "^NC-SB")

// create datalevel funciton based on codes 
gen DataLevel = "School"
replace DataLevel = "District" if StateAssignedDistID != ""
replace DataLevel = "State" if StateAssignedSchID == "NC-SEA"

replace StateAssignedSchID = "" if DataLevel == "District" | DataLevel == "State"

replace StateAssignedDistID = substr(StateAssignedSchID, 1, 3) if DataLevel == "School"

rename StateAssignedDistID State_leaid

gen StateAssignedSchID_full = StateAssignedSchID // keeping to replace back later 

//making state assigned school ID just 3 for match 
replace StateAssignedSchID = substr(StateAssignedSchID, 4, .)

merge m:1 State_leaid using "$North Carolina/NCES_2024_District.dta"
rename _merge DistMerge
drop if DistMerge == 2

drop DistMerge

rename StateAssignedSchID seasch
merge m:1 State_leaid seasch using "$North Carolina/NCES_2024_School.dta"
rename _merge SchoolMerge
drop if SchoolMerge == 2
drop SchoolMerge 
rename StateAssignedSchID seasch
merge m:1 State_leaid using  "$North Carolina/NC_district_IDs_2024.dta" 

rename seasch StateAssignedSchID 
rename State_leaid StateAssignedDistID 

// create separate district and school names, based on length of code (or datalevel function)
replace DistName = SchName if DataLevel == "District"

// hardcoding DataLevel 
label def DataLevel 1 "State" 2 "District" 3 "School"
encode DataLevel, gen(DataLevel_n) label(DataLevel)
sort DataLevel_n 
drop DataLevel 
rename DataLevel_n DataLevel 

// "All Districts" and "All School" creation
replace DistName = "All Districts" if DataLevel == 1
replace SchName = "All Schools" if DataLevel == 1
replace SchName = "All Schools" if DataLevel == 2

//Unmerged Schools
replace NCESSchoolID = "370201003674" if SchName == "LaFayette Elementary"
replace SchVirtual = 0 if SchName == "LaFayette Elementary"
replace SchType = 1 if SchName == "LaFayette Elementary"
replace SchLevel = 1 if SchName == "LaFayette Elementary"
replace DistName = "Harnett County Schools" if SchName == "LaFayette Elementary"

replace NCESSchoolID = "370399003447" if SchName == "Moss Street Elementary"
replace SchVirtual = 0 if SchName == "Moss Street Elementary"
replace SchType = 1 if SchName == "Moss Street Elementary"
replace SchLevel = 1 if SchName == "Moss Street Elementary"
replace DistName = "Rockingham County Schools" if SchName == "Moss Street Elementary"

replace NCESSchoolID = "370001203668" if SchName == "Pitt County Virtual"
replace SchVirtual = 1 if SchName == "Pitt County Virtual"
replace SchType = 1 if SchName == "Pitt County Virtual"
replace SchLevel = 4 if SchName == "Pitt County Virtual"
replace DistName = "Pitt County Schools" if SchName == "Pitt County Virtual"

replace NCESSchoolID = "370297003663" if SchName == "Turning Point Middle"
replace SchVirtual = 0 if SchName == "Turning Point Middle"
replace SchType = 4 if SchName == "Turning Point Middle"
replace SchLevel = 2 if SchName == "Turning Point Middle"
replace DistName = "Charlotte-mecklenburg Schools" if SchName == "Turning Point Middle"

replace SchVirtual = 0 if SchName == "Wayne STEM Academy"
replace SchLevel = 1 if SchName == "Wayne STEM Academy"

replace SchVirtual = 0 if SchName == "Tabor City School"
replace SchLevel = 1 if SchName == "Tabor City School"

replace SchVirtual = 0 if SchName == "Selma Burke Middle"
replace SchLevel = 2 if SchName == "Selma Burke Middle"

replace SchVirtual = 0 if NCESSchoolID == "370297003649"
replace SchLevel = 1 if NCESSchoolID == "370297003649"

replace SchVirtual = 0 if NCESSchoolID == "370297003650"
replace SchLevel = 1 if NCESSchoolID == "370297003650"

replace SchVirtual = 0 if NCESSchoolID == "370058003643"
replace SchLevel = 4 if NCESSchoolID == "370058003643"

replace SchVirtual = 0 if NCESSchoolID == "370047903617"
replace SchLevel = 4 if NCESSchoolID == "370047903617"

replace SchVirtual = 0 if NCESSchoolID == "370507103642"
replace SchLevel = 1 if NCESSchoolID == "370507103642"

replace SchVirtual = 0 if NCESSchoolID == "370507703655"
replace SchLevel = 1 if NCESSchoolID == "370507703655"

gen ParticipationRate = "--" 
gen ProficientOrAbove_count = "-"
gen Lev1_count = "-" 
gen Lev2_count = "-" 
gen Lev3_count = "-" 
gen Lev4_count = "-" 


gen StudentGroup_TotalTested = StudentSubGroup_TotalTested
destring StudentGroup_TotalTested, replace force ignore(",")
bys StudentGroup Subject GradeLevel DistName SchName: egen StudentGroup_TotalTested1 = total(StudentGroup_TotalTested)
replace StudentGroup_TotalTested1 = . if StudentGroup_TotalTested1 < 0
tostring StudentGroup_TotalTested1 StudentSubGroup_TotalTested, replace
replace StudentGroup_TotalTested1 = "*" if StudentGroup_TotalTested1 == "."
drop StudentGroup_TotalTested
rename StudentGroup_TotalTested1 StudentGroup_TotalTested

foreach var of varlist Lev1_percent Lev2_percent Lev3_percent Lev4_percent ProficientOrAbove_percent {
    // Replace ">" with a range (remove ">" and add "-1")
    replace `var' = subinstr(`var', ">", "", .) + "-1" if strpos(`var', ">") != 0
    
    // Replace "<" with a range (replace "<" with "0-")
    replace `var' = subinstr(`var', "<", "0-", .) if strpos(`var', "<") != 0
}

// split ranged percents
local a  "1 2 3 4" 
foreach b in `a' {
split Lev`b'_percent, parse("-")
}

// split ranged ProficientOrAbove_percent
split ProficientOrAbove_percent, parse("-")

// destring variables (convert to numeric)
destring Lev1_percent1 Lev2_percent1 Lev3_percent1 Lev4_percent1 ProficientOrAbove_percent1, replace ignore("*") // small change as compared to 2016-2021

// calculate lower bound of count range 
gen Lev1_count1 = Lev1_percent1* StudentSubGroup_TotalTested
gen Lev2_count1 = Lev2_percent1* StudentSubGroup_TotalTested
gen Lev3_count1 = Lev3_percent1* StudentSubGroup_TotalTested
gen Lev4_count1 = Lev4_percent1* StudentSubGroup_TotalTested
gen ProficientOrAbove_count1 = ProficientOrAbove_percent1* StudentSubGroup_TotalTested

destring  Lev1_percent2 Lev2_percent2 Lev3_percent2 Lev4_percent2 ProficientOrAbove_percent2, replace

// calculate upper bound of count range 
gen Lev1_count2 = Lev1_percent2* StudentSubGroup_TotalTested
gen Lev2_count2 = Lev2_percent2* StudentSubGroup_TotalTested
gen Lev3_count2 = Lev3_percent2* StudentSubGroup_TotalTested
gen Lev4_count2 = Lev4_percent2* StudentSubGroup_TotalTested
gen ProficientOrAbove_count2 = ProficientOrAbove_percent2* StudentSubGroup_TotalTested

// round upper bound, concatenate lower and upper bounds together
local a  "1 2 3 4" 
foreach b in `a' {
replace Lev`b'_count1 = round(Lev`b'_count1, 1)
replace Lev`b'_count2 = round(Lev`b'_count2, 1)
tostring Lev`b'_count1 Lev`b'_count2, replace force 
egen Lev`b'_countX = concat(Lev`b'_count1 Lev`b'_count2) if Lev`b'_count2 != ".", punct("-") 
replace Lev`b'_countX = Lev`b'_count1 if Lev`b'_count2 == "."
drop Lev`b'_count1 Lev`b'_count2 Lev`b'_percent1 Lev`b'_percent2
replace Lev`b'_count = Lev`b'_countX
drop Lev`b'_count
rename Lev`b'_countX Lev`b'_count
}

// if the range is a range of two of the same values, convert to exact value 
local a  "1 2 3 4" 
foreach b in `a' {
split Lev`b'_count, parse("-")
replace Lev`b'_count = Lev`b'_count1 if Lev`b'_count1 = Lev`b'_count2
drop Lev`b'_count1 Lev`b'_count2
}

//Code to Convert to Decimals with Ranges
foreach var of varlist Lev1_percent Lev2_percent Lev3_percent Lev4_percent ProficientOrAbove_percent {
	split `var', parse("-")
	destring `var'1, replace i(-)
	destring `var'2, replace i(-)
	replace `var'1 = `var'1/100
	replace `var'2 = `var'2/100
	replace `var' = string(`var'1, "%6.0g") if !inlist(`var', "*", "--") & `var'2 == .
	replace `var' = string(`var'1, "%6.0g") + "-" + string(`var'2, "%6.0g") if !inlist(`var', "*", "--") & `var'2 != .
}	

//Removing extra spaces
foreach var of varlist DistName SchName {
	replace `var' = stritrim(`var') // collapses all consecutive, internal blanks to one blank.
	replace `var' = strtrim(`var') // removes leading and trailing blanks
}

//Getting rid of empty observations
drop if StudentSubGroup_TotalTested == "--" & Lev1_percent == "--" & Lev2_percent == "--" & Lev3_percent == "--" & Lev4_percent == "--" & ProficientOrAbove_percent == "--"
replace AvgScaleScore = "--" if AvgScaleScore == "."
replace ParticipationRate = "--" if ParticipationRate == "."

//StudentGroup_TotalTested Convention
sort DataLevel DistName SchName Subject GradeLevel StudentGroup StudentSubGroup
gen All_Students = StudentSubGroup_TotalTested if StudentSubGroup == "All Students"
replace All_Students = All_Students[_n-1] if missing(All_Students)
replace StudentGroup_TotalTested = All_Students

order State StateAbbrev StateFips SchYear DataLevel DistName SchName NCESDistrictID StateAssignedDistID NCESSchoolID StateAssignedSchID AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_sci Flag_CutScoreChange_soc DistType DistCharter DistLocale SchType SchLevel SchVirtual CountyName CountyCode

keep State StateAbbrev StateFips SchYear DataLevel DistName SchName NCESDistrictID StateAssignedDistID NCESSchoolID StateAssignedSchID AssmtName AssmtType Subject GradeLevel StudentGroup StudentGroup_TotalTested StudentSubGroup StudentSubGroup_TotalTested Lev1_count Lev1_percent Lev2_count Lev2_percent Lev3_count Lev3_percent Lev4_count Lev4_percent Lev5_count Lev5_percent AvgScaleScore ProficiencyCriteria ProficientOrAbove_count ProficientOrAbove_percent ParticipationRate Flag_AssmtNameChange Flag_CutScoreChange_ELA Flag_CutScoreChange_math Flag_CutScoreChange_sci Flag_CutScoreChange_soc DistType DistCharter DistLocale SchType SchLevel SchVirtual CountyName CountyCodesave NC_AssmtData_2024, replace
export delimited NC_AssmtData_2024.csv, replace
